<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil del Estudiante – Juan Pérez</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Fuente Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    *{font-family:'Poppins',sans-serif}

    .table-header-claro th{
      background-color:#B0BEC5!important;
      color:#212121!important;
      text-align:center;
      font-weight:700;
      border-color:#ffffff!important;
      white-space:nowrap
    }

    html,body{height:100%;overflow-x:hidden}
    body{position:relative}
    body::before{
      content:"";position:fixed;inset:0;z-index:-1;
      background-image:url('assets/imagenes/evalix.png');
      background-repeat:repeat;
      background-size:140px 140px;
      background-position:0 0;
      opacity:.10;
      filter:saturate(120%) contrast(110%);
      pointer-events:none;
      animation:moverMosaico 40s linear infinite
    }
    @keyframes moverMosaico{0%{background-position:0 0}100%{background-position:500px 500px}}

    /* === Chips azules con borde (tipo botón/etiqueta) === */
    .chip-blue{
      display:inline-block;
      border:2px solid #248af0;
      color:#248af0;
      background:#eef6ff;
      padding:.28rem .75rem;
      border-radius:999px;
      font-size:.85rem;
      font-weight:600;
    }

    /* === Recuadro gris SOLO en la fila de filtros === */
    .filters-row th{
      background:#f1f3f5 !important;
      border-top:2px solid #dfe5ea !important;
      border-bottom:2px solid #dfe5ea !important;
      padding-top:.6rem;
      padding-bottom:.6rem;
    }
    .filters-row th:first-child{
      border-left:2px solid #dfe5ea !important;
      border-top-left-radius:12px;
      border-bottom-left-radius:12px;
    }
    .filters-row th:last-child{
      border-right:2px solid #dfe5ea !important;
      border-top-right-radius:12px;
      border-bottom-right-radius:12px;
    }

    .th-filter select{min-width:160px}

    /* Responsive */
    .form-control.form-control-sm,
    .form-select.form-select-sm,
    .input-group.input-group-sm .form-control,
    .input-group.input-group-sm .btn{
      padding-top:.35rem;
      padding-bottom:.35rem;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark" style="background-color:#6cc1e9;position:relative;height:80px;">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center position-relative" href="index.html" style="z-index:2;">
        <img src="assets/imagenes/evalix.png" alt="Evalix" style="width:75px;height:75px;object-fit:contain;margin-top:-5px;"/>
      </a>
      <span class="fw-bold text-white position-absolute top-50 start-50 translate-middle"><strong>PANEL ESTUDIANTE</strong></span>
      <div class="text-end ms-auto">
        <span id="userEmail" class="text-white-50 me-3">juan.perez@instituto.com</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn"><strong>Cerrar sesión</strong></button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <!-- Resumen -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap justify-content-between align-items-center">
        <div>
          <h4 class="mb-0">Juan Pérez</h4>
          <div class="text-muted">Id Estudiante: <strong>1001</strong></div>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <span id="chipMaterias" class="chip-blue">Materias: 3</span>
          <span id="chipPromedio" class="chip-blue">Promedio general: 0.00</span>
        </div>
      </div>
    </div>

    <!-- Tabla con filtros -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-end mb-3">
          <button id="exportBtn" class="btn btn-sm" style="background-color:#0b851b;color:#fff;border:none;" disabled>
            <strong>Exportar Excel</strong>
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Asignatura</th>
                <th>Período</th>
                <th>N1</th>
                <th>N2</th>
                <th>N3</th>
                <th>N4</th>
                <th>Promedio</th>
                <th>Estado</th>
              </tr>

              <!-- FILA DE FILTROS CON RECUADRO GRIS -->
              <tr class="filters-row">
                <th class="th-filter">
                  <select id="asignatura" class="form-select form-select-sm">
                    <option value="">-- Selecciona --</option>
                    <option>Matemáticas</option>
                    <option>Lengua</option>
                    <option>Inglés</option>
                  </select>
                </th>
                <th class="th-filter">
                  <select id="periodo" class="form-select form-select-sm">
                    <option value="">Todos</option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                  </select>
                </th>
                <th colspan="6" class="th-filter text-muted text-start">
                  <small>Usa los filtros para visualizar tus calificaciones.</small>
                </th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    const el=id=>document.getElementById(id);
    const APROBADO_MIN=3.0;

    // === Función del botón Cerrar Sesión ===
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', ()=>{
      // Limpia datos locales (si los hay) y redirige al index
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "index.html";
    });

    const notas=[
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Matemáticas",periodo:1,n1:4.2,n2:4.5,n3:4.1,n4:4.3},
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Matemáticas",periodo:2,n1:3.9,n2:4.0,n3:4.2,n4:4.1},
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Matemáticas",periodo:3,n1:"",n2:"",n3:"",n4:""},
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Lengua",periodo:1,n1:4.0,n2:3.9,n3:4.2,n4:4.4},
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Lengua",periodo:2,n1:4.1,n2:4.2,n3:4.3,n4:4.5},
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Lengua",periodo:3,n1:"",n2:"",n3:"",n4:""},
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Inglés",periodo:1,n1:3.8,n2:4.0,n3:4.1,n4:4.3},
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Inglés",periodo:2,n1:4.0,n2:4.1,n3:4.2,n4:4.3},
      {documento:"1020",nombre:"Juan Pérez",asignatura:"Inglés",periodo:3,n1:"",n2:"",n3:"",n4:""}
    ];

    const calcProm=r=>{
      const arr=[r.n1,r.n2,r.n3,r.n4].map(v=>v===""?0:Number(v)||0);
      return Number((arr.reduce((a,b)=>a+b,0)/4).toFixed(2));
    };
    const estado=p=>p>=APROBADO_MIN?"Aprobado":"Reforzar";
    const fmt=v=>v===""?"":Number(v).toFixed(1);

    let lastRendered=[];

    function render(rows){
      const tbody=el('tbody');
      lastRendered=rows;
      el('exportBtn').disabled=rows.length===0;

      if(!rows.length){
        tbody.innerHTML=`<tr><td colspan="8" class="text-center text-muted">Selecciona Asignatura/Período para ver las notas</td></tr>`;
        el('chipMaterias').textContent="Materias: 0";
        el('chipPromedio').textContent="Promedio general: 0.00";
        return;
      }
      const promG=(rows.reduce((a,r)=>a+calcProm(r),0)/rows.length).toFixed(2);
      el('chipMaterias').textContent=`Materias: ${rows.length}`;
      el('chipPromedio').textContent=`Promedio general: ${promG}`;

      tbody.innerHTML=rows.map(r=>{
        const p=calcProm(r);
        const est=estado(p);
        const badge=est==='Aprobado'?'bg-success':'bg-warning text-dark';
        return `
          <tr>
            <td>${r.asignatura}</td>
            <td>${r.periodo}</td>
            <td>${fmt(r.n1)}</td>
            <td>${fmt(r.n2)}</td>
            <td>${fmt(r.n3)}</td>
            <td>${fmt(r.n4)}</td>
            <td><span class="badge bg-primary">${p.toFixed(1)}</span></td>
            <td><span class="badge ${badge}">${est}</span></td>
          </tr>`;
      }).join('');
    }

    function aplicarFiltros(){
      const asig=el('asignatura').value;
      const per =el('periodo').value;
      if(!asig){render([]);return;}
      let rows=notas.filter(r=>r.asignatura===asig);
      if(per) rows=rows.filter(r=>String(r.periodo)===per);
      if(!rows.length){rows=[{asignatura:asig,periodo:per||"1",n1:"",n2:"",n3:"",n4:""}];}
      render(rows);
    }

    function exportarExcel(){
      if(!lastRendered.length) return;
      const rows=lastRendered.map(r=>({
        Asignatura:r.asignatura,
        Periodo:r.periodo,
        N1:r.n1===""?"":Number(r.n1).toFixed(1),
        N2:r.n2===""?"":Number(r.n2).toFixed(1),
        N3:r.n3===""?"":Number(r.n3).toFixed(1),
        N4:r.n4===""?"":Number(r.n4).toFixed(1),
        Promedio:calcProm(r).toFixed(1),
        Estado:calcProm(r)>=3?"Aprobado":"Reforzar",
      }));
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb,ws,"Notas");
      XLSX.writeFile(wb,"notas_juan_perez.xlsx");
    }

    el('asignatura').addEventListener('change',aplicarFiltros);
    el('periodo').addEventListener('change',aplicarFiltros);
    el('exportBtn').addEventListener('click',exportarExcel);
    render([]);
  </script>
</body>
</html>
