<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Docente – Evalix</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600&family=Orbitron:wght@600&display=swap" rel="stylesheet">

  <style>
    :root { --azul-primario: #2196f3; --azul-oscuro: #0d47a1; }
    html, body { height: 100%; overflow-x: hidden; }
    body {
      font-family: 'Exo 2', sans-serif;
      background-color: #f5f9ff;
      position: relative;
    }

    /* Mosaico tipo marca de agua con movimiento (como el original) */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image: url('assets/imagenes/evalix.png');
      background-repeat: repeat;
      background-size: 140px 140px;
      background-position: 0 0;
      opacity: 0.08;
      filter: saturate(110%) contrast(105%);
      pointer-events: none;
      animation: moverMosaico 40s linear infinite;
    }
    @keyframes moverMosaico { 0%{background-position:0 0;}100%{background-position:500px 500px;} }

    nav.navbar { background-color: var(--azul-primario); height: 80px; position: relative; }
    nav .navbar-brand img { width: 75px; height: 75px; object-fit: contain; margin-top: -5px; cursor: default; pointer-events: none; }
    nav .panel-title {
      position: absolute; top:50%; left:50%; transform: translate(-50%,-50%);
      color: white; font-family: 'Orbitron', sans-serif; font-weight: 600;
    }

    main.container { padding-top: 18px; padding-bottom: 36px; }
    table { font-size: 0.85rem; } /* dos tamaños mas pequeños */
    .table-header-claro th {
      background-color: #B0BEC5 !important;
      color: #212121 !important;
      text-align: center;
      font-weight: 700;
      border-color: #ffffff !important;
      white-space: nowrap;
    }
    #gradesTable td .form-control, #gradesTable td .form-select { font-size: 0.85rem; padding-top: .35rem; padding-bottom: .35rem; }

    /* inputs de visualización (id/doc/nombre) */
    .cell-view-input { background: transparent; border: none; padding: .375rem .5rem; width: 100%; text-align: left; }

    @media (max-width: 576px) {
      nav.navbar { height: 64px !important; }
      nav.navbar img[alt="Evalix"] { width: 56px !important; height: 56px !important; margin-top: -4px !important; }
      .table-header-claro th { font-size: .85rem; }
      #gradesTable td .form-control, #gradesTable td .form-select { font-size: .9rem; }
    }
    @media (max-width: 768px) {
      .table-header-claro th { font-size: .9rem; }
      #gradesTable td .form-control, #gradesTable td .form-select { font-size: .95rem; }
    }
  </style>
</head>
<body class="bg-light">

  <nav class="navbar navbar-dark">
    <div class="container-fluid d-flex align-items-center justify-content-between">
      <div class="navbar-brand d-flex align-items-center">
        <img src="assets/imagenes/evalix.png" alt="Evalix Logo">
      </div>
      <span class="panel-title"><strong>PANEL DOCENTE</strong></span>
      <div class="user-area text-end">
        <span id="userEmail" class="text-white-50 me-3"></span>
        <button id="logoutBtn" class="btn btn-outline-light btn-sm"><strong>Cerrar sesión</strong></button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="d-flex flex-wrap gap-3 align-items-end mb-3 controls">
      <div>
        <label class="form-label"><strong>Año lectivo</strong></label>
        <input type="number" id="anio" class="form-control" value="2025" min="2000" max="2100">
      </div>
      <div>
        <label class="form-label"><strong>Período</strong></label>
        <select id="periodo" class="form-select">
          <option value="1">Período 1</option>
          <option value="2">Período 2</option>
          <option value="3">Período 3</option>
          <option value="4">Período 4</option>
        </select>
      </div>
      <div>
        <label class="form-label"><strong>Asignatura</strong></label>
        <select id="asignatura" class="form-select">
          <option value="matematicas">Matemáticas</option>
          <option value="ciencias">Ciencias</option>
          <option value="espanol">Español</option>
        </select>
      </div>
      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-success" id="saveBtn">Guardar</button>
        <button class="btn btn-secondary" id="exportBtn">Exportar CSV</button>
        <button class="btn btn-outline-danger" id="clearBtn">Limpiar todo</button>
      </div>
    </div>

    <div class="alert alert-warning d-none" id="netStatus"></div>

    <div class="table-responsive">
      <table class="table table-striped align-middle" id="gradesTable">
        <thead class="table-header-claro">
          <tr>
            <th>Id Estudiante</th>
            <th style="min-width:160px;">Documento</th>
            <th>Estudiante</th>
            <th>Nota 1</th>
            <th>Nota 2</th>
            <th>Nota 3</th>
            <th>Nota 4</th>
            <th>Promedio</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="gradesTbody"></tbody>
      </table>
    </div>
  </main>

  <script>
    /* ===========================================================
       CONSTANTES / UTILIDADES
       =========================================================== */
    const STORAGE_PREFIX = 'evalix_notas_';
    function randomIntBetween(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

    // Normaliza nota a un número con 1 decimal (Number) o '' si vacío
    function normalizeToOneDecimalNumberOrEmpty(v){
      if (v === '' || v === null || v === undefined) return '';
      const n = parseFloat(String(v).replace(',', '.'));
      if (Number.isNaN(n)) return '';
      const clamped = Math.max(0, Math.min(5, n));
      // redondear a 1 decimal
      return Math.round(clamped * 10) / 10;
    }

    // Devuelve string para mostrar en input con una decimal (ej: 4.0, 4.1)
    function formatNoteInputOneDecimal(val){
      if (val === '' || val === null || val === undefined) return '';
      const num = Number(val);
      if (Number.isNaN(num)) return '';
      return num.toFixed(1);
    }

    /* ===========================================================
       ESTADO GLOBAL y DOM refs
       =========================================================== */
    let state = { anio: 2025, periodo: 1, nextId: 1001, rows: [] };
    const tbody = document.getElementById('gradesTbody');
    const anioInput = document.getElementById('anio');
    const periodoSel = document.getElementById('periodo');
    const asignaturaSel = document.getElementById('asignatura');
    const netStatus = document.getElementById('netStatus');
    const userEmailSpan = document.getElementById('userEmail');

    /* ===========================================================
       ARRAY: nombres por asignatura (25 cada)
       =========================================================== */
    const NOMBRES = {
      matematicas: ["Juan Pérez","María López","Carlos Gómez","Laura Torres","Andrés Rojas","Sofía Ramírez","Felipe Castro","Valentina Díaz","Daniel Herrera","Camila Ortiz","Sebastián Morales","Natalia Ruiz","Tomás Vargas","Lucía Mendoza","Diego Silva","Isabella Romero","Santiago Navarro","Paula Martínez","Julián León","Gabriela Cruz","David Torres","Alejandra Peña","Martín Gil","Daniela Arias","Simón Cárdenas"],
      ciencias: ["Marcos Peña","Estefanía Blanco","Hernán Salazar","Mónica Gil","Óscar Pinto","Rocío Velásquez","Iván Cabrera","Carolina Mena","Raúl Fuentes","Adriana Solano","Germán Varela","Noelia Cano","Enrique Paredes","Karen Acosta","Lina Bravo","Alonso Rubio","Marta Bernal","Pablo Duarte","Melisa Ocampo","Óliver Correa","Verónica Salinas","Rubén Maldonado","Marina Solís","Fabián Vidal","Teresa Lozano"],
      espanol: ["Claudia Ríos","Roque Medina","Elena Aguirre","Gonzalo Peña","Marina Patiño","Ivanna Gómez","Ramiro Castillo","Mireya Cifuentes","Luis Navarro","Beatriz Salcedo","Federico Prada","Lorena Bravo","Hugo Santana","Vanessa León","Norberto Cruz","Paola Vargas","Rubén Rojas","Angélica Molina","César Silva","Nerea Duarte","Javier Cortés","Bianca Herrera","Mauricio Ortiz","Ariadna Muñoz","Marcelo García"]
    };

    // Genera estudiantes: id secuencial (1001...), documento aleatorio no consecutivo 8-dígitos, notas vacías
    function generateStudentsFor(subjectKey){
      const names = NOMBRES[subjectKey] || NOMBRES.matematicas;
      const usedDocs = new Set();
      return names.map((fullName, i) => {
        let doc;
        do { doc = String(randomIntBetween(10000000, 99999999)); } while (usedDocs.has(doc));
        usedDocs.add(doc);
        return {
          idEst: String(1001 + i),
          documento: doc,
          nombre: fullName,
          n1: '', n2: '', n3: '', n4: '', // VACÍAS (no predeterminadas)
          prom: 0
        };
      });
    }

    /* ===========================================================
       FETCH SIMULADO / ASINCRONÍA
       =========================================================== */
    async function fetchStudentsFor(subjectKey){
      return new Promise(resolve => setTimeout(()=>resolve(generateStudentsFor(subjectKey)), 300));
    }

    /* ===========================================================
       LÓGICA: promedio (1 decimal) y render
       =========================================================== */
    function calcPromedio(row){
      // convertir valores guardados ('' o Number)
      const notes = [row.n1, row.n2, row.n3, row.n4]
        .map(v => (v === '' ? '' : Number(v)))
        .filter(v => v !== '');
      const avg = notes.length ? (notes.reduce((a,b)=>a+b,0) / notes.length) : 0;
      row.prom = Math.round(avg * 10) / 10; // 1 decimal
      return row.prom;
    }

    function renderRows(){
      tbody.innerHTML = '';
      state.rows.forEach((r, idx) => {
        calcPromedio(r); // asegura prom actualizado
        const tr = document.createElement('tr');

        // Id/Documento/Nombre son inputs readonly para visualización (no editables)
        // notas son inputs editables, STEP 0.1 para permitir décimas (0.0,0.1,0.2,...5.0)
        tr.innerHTML = `
          <td><input class="form-control form-control-sm cell-view-input" value="${r.idEst}" readonly></td>
          <td><input class="form-control form-control-sm cell-view-input" value="${r.documento}" readonly></td>
          <td><input class="form-control form-control-sm cell-view-input" value="${r.nombre}" readonly></td>

          <td><input class="form-control form-control-sm nota" type="number" step="0.1" min="0" max="5" value="${formatNoteInputOneDecimal(r.n1)}" data-k="n1"></td>
          <td><input class="form-control form-control-sm nota" type="number" step="0.1" min="0" max="5" value="${formatNoteInputOneDecimal(r.n2)}" data-k="n2"></td>
          <td><input class="form-control form-control-sm nota" type="number" step="0.1" min="0" max="5" value="${formatNoteInputOneDecimal(r.n3)}" data-k="n3"></td>
          <td><input class="form-control form-control-sm nota" type="number" step="0.1" min="0" max="5" value="${formatNoteInputOneDecimal(r.n4)}" data-k="n4"></td>

          <td><span class="prom-badge badge bg-${r.prom >= 3 ? 'success':'danger'}">${(r.prom ? r.prom.toFixed(1) : '0.0')}</span></td>
          <td><button type="button" class="btn btn-sm btn-outline-danger" data-del="${idx}">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===========================================================
       CARGA / GUARDADO / EXPORT / LIMPIAR
       =========================================================== */
    async function loadSubject(){
      state.anio = parseInt(anioInput.value, 10) || 2025;
      state.periodo = parseInt(periodoSel.value, 10) || 1;

      const key = STORAGE_PREFIX + asignaturaSel.value;
      const raw = localStorage.getItem(key);
      if (raw) {
        try {
          state.rows = JSON.parse(raw);
          showStatus('Datos cargados desde localStorage.', 'success');
          renderRows();
          return;
        } catch (e) { console.warn('parse error', e); }
      }

      showStatus('Cargando estudiantes...', 'info');
      state.rows = await fetchStudentsFor(asignaturaSel.value);
      showStatus('25 estudiantes cargados.', 'success');
      renderRows();
    }

    // Guardar: recoger notas desde inputs y persistir
    function saveState(){
      const rowsTr = [...tbody.children];
      rowsTr.forEach((tr, idx) => {
        const inputs = tr.querySelectorAll('[data-k]');
        inputs.forEach(inp => {
          const k = inp.getAttribute('data-k');
          const normalized = normalizeToOneDecimalNumberOrEmpty(inp.value); // Number or ''
          state.rows[idx][k] = (normalized === '' ? '' : normalized);
        });
        calcPromedio(state.rows[idx]);
      });
      try {
        localStorage.setItem(STORAGE_PREFIX + asignaturaSel.value, JSON.stringify(state.rows));
        showStatus('Datos guardados correctamente.', 'success');
      } catch (e) {
        console.error(e);
        showStatus('Error guardando datos.', 'danger');
      }
    }

    function exportCSV(){
      const headers = ['Id Estudiante','Documento','Estudiante','Nota 1','Nota 2','Nota 3','Nota 4','Promedio'];
      const rows = state.rows.map(r => [
        r.idEst, r.documento, r.nombre,
        (r.n1 === '' ? '' : Number(r.n1).toFixed(1)),
        (r.n2 === '' ? '' : Number(r.n2).toFixed(1)),
        (r.n3 === '' ? '' : Number(r.n3).toFixed(1)),
        (r.n4 === '' ? '' : Number(r.n4).toFixed(1)),
        (r.prom === '' ? '' : Number(r.prom).toFixed(1))
      ]);
      const csv = [headers.join(','), ...rows.map(a => a.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `evalix_${state.anio}_${asignaturaSel.value}.csv`;
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    function clearAll(){
      if (!confirm('Esto eliminará todas las filas guardadas localmente para esta asignatura. ¿Continuar?')) return;
      const key = STORAGE_PREFIX + asignaturaSel.value;
      localStorage.removeItem(key);
      loadSubject();
    }

    /* ===========================================================
       DOM / EVENTOS
       - Nota importante: NO normalizamos el valor en cada "input"
         para no interferir con la escritura del usuario.
       - La normalización (a 1 decimal) se hace en 'blur' y en 'change'
         y también al guardar (saveState), lo que te permite ingresar
         libremente 0.0, 0.1, 0.2 ... hasta 5.0.
       =========================================================== */

    // Delegación: eliminar fila
    tbody.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-del]');
      if (!btn) return;
      const idx = Number(btn.getAttribute('data-del'));
      state.rows.splice(idx, 1);
      renderRows();
    });

    // Delegación: permitimos entrada libre (input) para escribir décimas, pero normalizamos en blur/change
    tbody.addEventListener('blur', (e) => {
      const node = e.target;
      if (!node) return;
      const k = node.getAttribute && node.getAttribute('data-k');
      if (!k) return;
      if (!['n1','n2','n3','n4'].includes(k)) return;
      const tr = node.closest('tr');
      const idx = [...tbody.children].indexOf(tr);
      if (!Number.isFinite(idx)) return;

      // Normalizar y mostrar con 1 decimal
      const normalized = normalizeToOneDecimalNumberOrEmpty(node.value);
      node.value = (normalized === '' ? '' : formatNoteInputOneDecimal(normalized));
      state.rows[idx][k] = (normalized === '' ? '' : normalized);
      calcPromedio(state.rows[idx]);
      // actualizar badge en la fila
      const badge = tr.querySelector('.prom-badge');
      if (badge) badge.textContent = (state.rows[idx].prom ? state.rows[idx].prom.toFixed(1) : '0.0');
    }, true); // useCapture true to ensure blur on inputs is caught

    // Also listen to change to catch spinner/arrow edits
    tbody.addEventListener('change', (e) => {
      const node = e.target;
      const k = node.getAttribute && node.getAttribute('data-k');
      if (!k) return;
      if (!['n1','n2','n3','n4'].includes(k)) return;
      const tr = node.closest('tr');
      const idx = [...tbody.children].indexOf(tr);
      const normalized = normalizeToOneDecimalNumberOrEmpty(node.value);
      node.value = (normalized === '' ? '' : formatNoteInputOneDecimal(normalized));
      state.rows[idx][k] = (normalized === '' ? '' : normalized);
      calcPromedio(state.rows[idx]);
      const badge = tr.querySelector('.prom-badge');
      if (badge) badge.textContent = (state.rows[idx].prom ? state.rows[idx].prom.toFixed(1) : '0.0');
    });

    // Asignatura change
    asignaturaSel.addEventListener('change', loadSubject);

    // Botones
    document.getElementById('saveBtn').addEventListener('click', saveState);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    document.getElementById('clearBtn').addEventListener('click', clearAll);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('evalix_user');
      window.location.replace('index.html');
    });

    /* ===========================================================
       Helpers, UI y arranque
       =========================================================== */
    function showStatus(msg, type='info'){
      netStatus.classList.remove('d-none','alert-info','alert-success','alert-warning','alert-danger');
      netStatus.classList.add(`alert-${type}`);
      netStatus.textContent = msg;
      setTimeout(()=> netStatus.classList.add('d-none'), 3000);
    }

    (function init(){
      try {
        const u = JSON.parse(localStorage.getItem('evalix_user') || '{}');
        if (u && u.email) userEmailSpan.textContent = u.email;
      } catch {}
      anioInput.value = state.anio;
      periodoSel.value = state.periodo;
      loadSubject();
    })();

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
